---
title: "Speed-Accuracy Project Data Processing"
author: "Kyle MacDonald"
date: "October 1, 2015"
output: html_document
---

## Script to munge eye movement data

```{r}
rm(list=ls())
source("libraries_v_3.6.R")
library(langcog)
library(tidyr)
library(dplyr)
library(stringr)
library(magrittr)
library(stringr)
library(GGally)
library(kmr)
```

### Read in icharts for V1 and Trio

```{r}
sol_demo <- read.csv("../data/raw_data/sol_demo_all.csv", stringsAsFactors = F)
sol_df <- read.csv("../data/raw_data/sol-speed-acc-final-iChart.csv", stringsAsFactors = F)
sol_demo$Sub.Num <- as.character(sol_demo$Sub.Num)
```

```{r}
trio_df <- read.csv("../data/raw_data/TrioFace26n24orig_km.csv", stringsAsFactors = F)
trio_prescreening <- read.csv("../data/raw_data/trio_prescreening_info.csv", sep = ",", stringsAsFactors = F)
```

Add trio prescreening info to iChart.

```{r}
trio_prescreening %<>%
    select(Sub.Num, PSO.Reason, Tr.Num) %>% 
    mutate(Sub.Num = as.character(Sub.Num),
           Tr.Num = as.character(Tr.Num))

trio_df <- left_join(x = trio_df, y = trio_prescreening, by = c("Sub.Num", "Tr.Num"))
```

### Add variable to track language 

```{r}
sol_df$language_modality <- "ASL"
trio_df$language_modality <- "English"
trio_df$stimuli <- "trio"
```

### Filter ASL data to just keep frames 0 - 3000

3000ms is the length of the spoken language trials.

```{r}
sol_df_filtered <- sol_df %>% 
    select(Sub.Num, Months, Tr.Num, Response, RT, stimuli,
           Prescreen.Notes, language_modality, X0:X3133) %>% 
    mutate(Sub.Num = as.character(Sub.Num),
           Tr.Num = as.character(Tr.Num)) 

trio_df_filtered <- trio_df %>% 
    select(Sub.Num, Months, Tr.Num, Response, Target.RT..sec., stimuli,
           PSO.Reason, language_modality, X0:X3133) %>% 
    dplyr::rename(Prescreen.Notes = PSO.Reason,
           RT = Target.RT..sec.) %>% 
    mutate(Months = as.integer(Months),
           X3133 = as.character(X3133),
           RT = as.integer(RT) * 1000)
```

### Bind data frames together

```{r}
speed_acc_df_final <- bind_rows(sol_df_filtered, trio_df_filtered)
```

## Munge and process eye movement data

Our goal is to get an RT and correct/incorrect for each good trial.

```{r}
iChart <- speed_acc_df_final %>% mutate(Sub.Num =  as.character(Sub.Num))
```

## Filter dataset

Filter out participants that should not go into analyses based on exclusionary criteria: a) age, b) didnâ€™t know signs in the task, c) not enough ASL exposure.

```{r}
include <- sol_demo %>%
    select(Sub.Num, include,
           reason_excluded, stimuli,
           age_code, signs_produced, 
           hearing_status_participant)

iChart <- left_join(iChart, include, by = c("Sub.Num", "stimuli")) 

iChart <- iChart %>% 
    filter(include == "yes" | language_modality == "English") %>% 
    mutate(age_code = ifelse(language_modality == "English", "child", age_code),
           hearing_status_participant = ifelse(language_modality == "English", 
                                               "hearing", hearing_status_participant))
```

### Remove prescreened out trials

```{r}
ss_prescreened <- iChart %>% 
    group_by(Sub.Num) %>% 
    filter(Prescreen.Notes != "") %>% 
    dplyr::summarise(num_prescreened = n())

iChart <- filter(iChart, Prescreen.Notes == "")
```

### Process iChart

First, we need to process the data, keeping only those trials on which the child was looking at the signer at F0.

* C: Center
* D: Distractor
* T: Target
* A: Away

includeOffCenter == FALSE -> only include trials child was looking at center at F0

includeOffCenter == TRUE -> include trials child was looking at center, target, or distractor at F0

```{r}
colnames(iChart) <- sapply(colnames(iChart), function (x) {
    str_replace(x, "X", "")  
})
```

```{r}
iChart %>% group_by("0", Response) %>% dplyr::summarise(Trials = n())

# change all trials to "Vanilla" 
iChart$Condition <- "Vanilla"

## define critical onset, change Cs to Ds and everything else to As
iChart <- defineOnsetSOL(iChart, critonset=0, end_critonset=300, 
                         includeOffCenter=FALSE, includeWindow = FALSE)

iChart %>% group_by("0", Response) %>% dplyr::summarise(Trials = n())
```

### Flag C-T and C-D Trials

Datawiz does not tell us which shifts land on a target vs. a disctractor. So we need to use a function that flags each trial as one of the following:

* C_T: center to target
* C_D: center to distractor
* C-C: center to center (child leaves the signer, goes away, and comes back to signer)
* no_shift
* off_signer

```{r}
# apply fun to each row in our dataset to flag trial type
trial_types <- apply(iChart, 1, trial_type_fun, start = "0", end = "3000") 

# merge trial type information with iChart
iChart <- cbind(iChart, trial_types)
```

```{r}
iChart %>% group_by(trial_types) %>% dplyr::summarise(Trials = n())
```

### Create summary table

First we need to get C_T proportions for each participant 

```{r}
iChart$Response <- as.vector(iChart$Response)

ss <- iChart %>%
    filter(trial_types %in% c("C_T", "C_D")) %>% 
    select(Sub.Num:language_modality, trial_types) %>% 
    mutate(age_years = Months / 12,
           rt_sec = RT / 1000,
           reponse = ifelse(trial_types == "C_T", 1, 0))

ss_kids <- filter(ss, age_code != "Adults")
```

### Save final/processed summary table

```{r}
write.csv(speed_acc_df_final, file = "sol-speed-acc-final-iChart.csv", row.names = F, na = "NA")
```